#!/usr/bin/env bash

set -e

[[ -z "${DEBUG}" ]] || [[ "${DEBUG,,}" = "false" ]] || [[ "${DEBUG,,}" = "0" ]] || set -x

if [[ "$(whoami)" != "${STEAM_USER}" ]]; then
  echo "run this script as steam-user"
  exit 1
fi

function may_update() {
  if [[ "${UPDATE_ON_START}" != "true" ]]; then
    return
  fi

  echo "\$UPDATE_ON_START is 'true'..."

  # auto checks if a update is needed, if yes, then update the server or mods
  # (otherwise it just does nothing)
  ${ARKMANAGER} update @main --verbose --update-mods --backup --no-autostart "${BETA_ARGS[@]}"
}

function create_missing_dir() {
  for DIRECTORY in "${@}"; do
    [[ -n "${DIRECTORY}" ]] || return
    if [[ ! -d "${DIRECTORY}" ]]; then
      mkdir -p "${DIRECTORY}"
      echo "...successfully created ${DIRECTORY}"
    fi
  done
}

function copy_missing_file() {
  SOURCE="${1}"
  DESTINATION="${2}"

  if [[ ! -f "${DESTINATION}" ]]; then
    cp -a "${SOURCE}" "${DESTINATION}"
    echo "...successfully copied ${SOURCE} to ${DESTINATION}"
  fi
}

function needs_install() {
  local SERVER_DIR="${ARK_SERVER_VOLUME}/server"
  if [ ! -d "${SERVER_DIR}" ]; then
    echo "${SERVER_DIR} not found ..."
    return 0
  fi

  # Backwards compatibility
  local VERSION_FILE="${SERVER_DIR}/version.txt"
  if [ -f "${VERSION_FILE}" ]; then
    echo "Already installed. (found ${VERSION_FILE})"
    return 1
  fi

  local INSTALLED_FILES=(
    "${SERVER_DIR}/steamapps/appmanifest_376030.acf"
    "${SERVER_DIR}/ShooterGame/Binaries/Linux/ShooterGameServer"
  )
  for FILE in "${INSTALLED_FILES[@]}"; do
    if [ ! -s "${FILE}" ]; then
      echo "${FILE} is not complete ..."
      return 0
    fi
  done

  echo "Already installed."
  return 1
}

function add_cluster_to_arkmanager_cfg() {
  local -r config="${ARK_TOOLS_DIR}/arkmanager.cfg"
  if ! grep -q '^arkopt_ClusterDirOverride=' "${config}"; then
    echo "Add cluster settings to old arkmanager.cfg ..."
    cat <<EOF >> "${config}"

# Cluster settings
arkflag_NoTransferFromFiltering=true
arkopt_ClusterDirOverride="/cluster"
arkopt_clusterid=\${CLUSTER_ID:-MyCluster}
EOF
  fi
}

function remake_sub_instances_cfg() {
  local key
  local -i i=1
  local -r instances_dir="${ARK_TOOLS_DIR}/instances"

  # remove old sub instance configs
  rm -f "${instances_dir}"/sub.*.cfg

  # create new sub instance configs
  for key in ${SUB_INSTANCE_KEYS//,/ }; do
    sed -r "${TEMPLATE_DIRECTORY}/arkmanager-sub.cfg.template" \
      -e "s/^# Template configuration.*$/# DO NOT EDIT THIS FILE - Auto-regenerated/i" \
      -e "s/<KEY>/${key}/g" \
      -e "s/<INDEX>/$((i))/g" \
      -e "s/<NUMBER_SUFFIX>/$((i+1))/g" \
      -e "s/<GAME_CLIENT_PORT>/$((GAME_CLIENT_PORT+i*2))/g" \
      -e "s/<SERVER_LIST_PORT>/$((SERVER_LIST_PORT+i))/g" \
      -e "s/<RCON_PORT>/$((RCON_PORT+i))/g" \
    > "${instances_dir}/sub.${key}.cfg"
    ((i++))
  done
}

function get_all_mod_ids() {
  local key mod_id var_name
  local -a collected=()

  [[ -n "${SERVER_MAP_MOD_ID}" ]] && collected+=("${SERVER_MAP_MOD_ID}")

  for mod_id in ${GAME_MOD_IDS//,/ }; do
    [[ -n "${mod_id}" ]] && collected+=("${mod_id}")
  done

  for key in ${SUB_INSTANCE_KEYS//,/ }; do
    var_name="SUB_${key}_SERVER_MAP_MOD_ID"
    [[ -n "${!var_name}" ]] && collected+=("${!var_name}")

    var_name="SUB_${key}_GAME_MOD_IDS"
    for mod_id in ${!var_name//,/ }; do
      [[ -n "${mod_id}" ]] && collected+=("${mod_id}")
    done
  done

  printf '%s\n' "${collected[@]}" | sort -u
}

args=("$@")
if [[ "${ENABLE_CROSSPLAY}" == "true" ]]; then
  args=('--arkopt,-crossplay' "${args[@]}")
fi
if [[ "${DISABLE_BATTLEYE}" == "true" ]]; then
  args=('--arkopt,-NoBattlEye' "${args[@]}")
fi
BETA_ARGS=(${BETA:+--beta=${BETA}} ${BETA_ACCESSCODE:+--betapassword=${BETA_ACCESSCODE}})

echo "_______________________________________"
echo ""
echo "# Ark Server - $(date)"
echo "# IMAGE_VERSION: '${IMAGE_VERSION}'"
echo "# RUNNING AS USER '${STEAM_USER}' - '$(id -u)'"
echo "# ARGS: ${args[*]}"
if [ -n "${BETA}" ]; then
  echo "# BETA: ${BETA}"
fi
echo "_______________________________________"

ARKMANAGER="$(command -v arkmanager)"
[[ -x "${ARKMANAGER}" ]] || (
  echo "Arkmanager is missing"
  exit 1
)

cd "${ARK_SERVER_VOLUME}"

echo "Setting up folder and file structure..."
create_missing_dir "${ARK_SERVER_VOLUME}/log" "${ARK_SERVER_VOLUME}/backup" "${ARK_SERVER_VOLUME}/staging"

# copy from template to server volume
copy_missing_file "${TEMPLATE_DIRECTORY}/arkmanager.cfg" "${ARK_TOOLS_DIR}/arkmanager.cfg"
copy_missing_file "${TEMPLATE_DIRECTORY}/arkmanager-user.cfg" "${ARK_TOOLS_DIR}/instances/main.cfg"
copy_missing_file "${TEMPLATE_DIRECTORY}/crontab" "${ARK_SERVER_VOLUME}/crontab"

add_cluster_to_arkmanager_cfg
remake_sub_instances_cfg

[[ -L "${ARK_SERVER_VOLUME}/Game.ini" ]] ||
  ln -s ./server/ShooterGame/Saved/Config/LinuxServer/Game.ini Game.ini
[[ -L "${ARK_SERVER_VOLUME}/GameUserSettings.ini" ]] ||
  ln -s ./server/ShooterGame/Saved/Config/LinuxServer/GameUserSettings.ini GameUserSettings.ini

if needs_install; then
  echo "No game files found. Installing..."

  create_missing_dir \
    "${ARK_SERVER_VOLUME}/server/ShooterGame/Saved/SavedArks" \
    "${ARK_SERVER_VOLUME}/server/ShooterGame/Content/Mods" \
    "${ARK_SERVER_VOLUME}/server/ShooterGame/Binaries/Linux"

  touch "${ARK_SERVER_VOLUME}/server/ShooterGame/Binaries/Linux/ShooterGameServer"
  chmod +x "${ARK_SERVER_VOLUME}/server/ShooterGame/Binaries/Linux/ShooterGameServer"

  if ! ${ARKMANAGER} install @main --verbose "${BETA_ARGS[@]}"; then
    echo "Installation failed"
    exit 1
  fi
fi

crontab "${ARK_SERVER_VOLUME}/crontab"

declare -a ALL_GAME_MOD_IDS=()
mapfile -t ALL_GAME_MOD_IDS < <(get_all_mod_ids)
if [[ ${#ALL_GAME_MOD_IDS[@]} -gt 0 ]]; then
  echo "Installing mods: '${ALL_GAME_MOD_IDS[*]}' ..."

  for MOD_ID in "${ALL_GAME_MOD_IDS[@]}"; do
    echo "...installing '${MOD_ID}'"

    if [[ -d "${ARK_SERVER_VOLUME}/server/ShooterGame/Content/Mods/${MOD_ID}" ]]; then
      echo "...already installed"
      continue
    fi

    ${ARKMANAGER} installmod "${MOD_ID}" --verbose
    echo "...done"
  done
fi

may_update

function terminate() {
  echo "Termination signal received."
  if ! ${ARKMANAGER} saveworld "@all" 2>/dev/null; then
    echo "Warning: Failed to issue saveworld command."
  fi
  # Both arkmanager stop @all and kill may time out.
  local pidfile
  local -i count=0
  for pidfile in ./server/ShooterGame/Saved/.arkmanager*.pid; do
    if [ -f "${pidfile}" ]; then
      local pid="$(cat "${pidfile}")"
      echo "Stopping arkmanager instance $(basename ${pidfile}) (${pid}) ..."
      kill -TERM "${pid}" 2>/dev/null && ((count++)) || true
    fi
  done
  echo "Sent stop signals to ${count} instance(s)."
  [ "${count}" -eq 0 ] && kill -TERM "${pids[@]}" 2>/dev/null || true
  echo "Waiting for all instances (${pids[*]}) to stop ..."
  wait "${pids[@]}"
  echo "done."
  exit 0
}

pids=()
# Removes state files left behind if the previous shutdown did not complete in time.
rm -vf ./server/ShooterGame/Saved/.*.pid ./server/ShooterGame/Saved/.autorestart
trap 'terminate' INT TERM
for config in ./arkmanager/instances/*.cfg; do
  instance="$(basename "${config%.*}")"
  echo "Run instance ${instance} ..."
  ${ARKMANAGER} run "@${instance}" --verbose "${args[@]}" &
  pids+=($!)
done
wait "${pids[@]}"
